import streamlit as st
import math

st.set_page_config(page_title="–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∞–≤–∞—Ä—ñ–π–Ω–æ–≥–æ –∑–ª–∏–≤—É", layout="wide")

st.title("üßÆ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å–∏—Å—Ç–µ–º–∏ –∞–≤–∞—Ä—ñ–π–Ω–æ–≥–æ —Å–ø–æ—Ä–æ–∂–Ω–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞")
st.write("–ü—Ä–æ–≥—Ä–∞–º–∞ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥—É —Ç–∞ —á–∞—Å—É –∑–ª–∏–≤—É —Ä—ñ–¥–∏–Ω–∏.")

# --- –ë—ñ—á–Ω–∞ –ø–∞–Ω–µ–ª—å –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
st.sidebar.header("–í—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏")

# –°–µ–∫—Ü—ñ—è 1: –ì–µ–æ–º–µ—Ç—Ä—ñ—è —Ç–∞ –æ–±'—î–º
with st.sidebar.expander("–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ —Ç–∞ –ì—ñ–¥—Ä–∞–≤–ª—ñ–∫–∞", expanded=True):
    Vp = st.number_input("–†–æ–±–æ—á–∏–π –æ–±'—î–º —Ä—ñ–¥–∏–Ω–∏ Vp, –º¬≥", value=15.0)
    F_res = st.number_input("–ü–ª–æ—â–∞ –ø–µ—Ä–µ—Ä—ñ–∑—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ F, –º¬≤", value=5.0)
    H1 = st.number_input("–í–∏—Å–æ—Ç–∞ H1 (–ø–æ—á–∞—Ç–æ–∫ –∑–ª–∏–≤—É), –º", value=4.0)
    H2 = st.number_input("–í–∏—Å–æ—Ç–∞ H2 (–∫—ñ–Ω–µ—Ü—å –∑–ª–∏–≤—É), –º", value=0.5)
    d_vn = st.number_input("–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –¥—ñ–∞–º–µ—Ç—Ä —Ç—Ä—É–±–∏ d_–≤–Ω, –º", value=0.1)

# –°–µ–∫—Ü—ñ—è 2: –ß–∞—Å–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
with st.sidebar.expander("–ß–∞—Å–æ–≤—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è"):
    t_zl_max = st.number_input("–î–æ–ø—É—Å—Ç–∏–º–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å [t]–∑–ª, —Å", value=900)
    t_oper = st.number_input("–ß–∞—Å –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è –≤ –¥—ñ—é t_–æ–ø–µ—Ä, —Å", value=300)

# –°–µ–∫—Ü—ñ—è 3: –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ —Ä—ñ–¥–∏–Ω–∏
with st.sidebar.expander("–í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ —Ä—ñ–¥–∏–Ω–∏"):
    rho = st.number_input("–ì—É—Å—Ç–∏–Ω–∞ —Ä—ñ–¥–∏–Ω–∏ œÅ, –∫–≥/–º¬≥", value=790.5)
    mu = st.number_input("–î–∏–Ω–∞–º—ñ—á–Ω–∞ –≤'—è–∑–∫—ñ—Å—Ç—å Œº, –ü–∞¬∑—Å", value=0.34)

# --- –†–û–ó–†–ê–•–£–ù–ö–û–í–ê –ß–ê–°–¢–ò–ù–ê ---

# 1 & 2. –ú—ñ—Å—Ü–µ–≤—ñ –æ–ø–æ—Ä–∏
# –î—ñ–ª—è–Ω–∫–∞ 1
x_vkh = 0.2
x_z = 0.5
x_k = 0.55
x_g = 3.0
L1 = 5.5
# –î—ñ–ª—è–Ω–∫–∞ 2
L2 = 3.0
x_vikh = 1.0

# –°—É–º–∞—Ä–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –º—ñ—Å—Ü–µ–≤–∏—Ö –æ–ø–æ—Ä—ñ–≤ (–ø—Ä–∏–∫–ª–∞–¥ –∑ –≤–∞—à–æ–≥–æ —Ç–µ–∫—Å—Ç—É)
# –§–æ—Ä–º—É–ª–∞: 1*0.2 + 1*0.5 + 2*0.55 + 1*3 + 1*1
zeta_c = (1 * x_vkh) + (1 * x_z) + (2 * x_k) + (1 * x_g) + (1 * x_vikh)

# 3. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å
t_sp_m = t_zl_max - t_oper

# 4. –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∏—Ç—Ä–∞—Ç–∏ (–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π)
phi_syst_init = 1 / math.sqrt(zeta_c)

# 5. –î—ñ–∞–º–µ—Ç—Ä (—Ç–µ–æ—Ä–µ—Ç–∏—á–Ω–∏–π, –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏)
# –§–æ—Ä–º—É–ª–∞: d = 0.758 * sqrt(Vp / (phi * t * sqrt(H1+H2)))
term_d = (Vp) / (phi_syst_init * t_sp_m * math.sqrt(H1 + H2))
d_tr_calc = 0.758 * math.sqrt(term_d)

# 6. –ü–ª–æ—â–∞ –ø–µ—Ä–µ—Ä—ñ–∑—É (–≤–∏—Ö–æ–¥—è—á–∏ –∑ –≤–≤–µ–¥–µ–Ω–æ–≥–æ d_vn)
f_tr = 0.785 * (d_vn**2)

# 7. –®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä—É—Ö—É
w = 2.22 * phi_syst_init * math.sqrt(H1 + H2)

# 8. –ö—Ä–∏—Ç–µ—Ä—ñ–π –†–µ–π–Ω–æ–ª—å–¥—Å–∞
Re = (w * d_vn * rho) / mu

# 9. –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Ç–µ—Ä—Ç—è
if Re < 2300:
    lambda_f = 64 / Re
else:
    lambda_f = 0.3164 / (Re**0.25) # –§–æ—Ä–º—É–ª–∞ –ë–ª–∞–∑—ñ—É—Å–∞ –¥–ª—è —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ–≥–æ

# 10. –£—Ç–æ—á–Ω–µ–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –æ–ø–æ—Ä—É —Å–∏—Å—Ç–µ–º–∏
zeta_syst = zeta_c + (lambda_f / d_vn) * (L1 + L2)

# 11. –£—Ç–æ—á–Ω–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∏
phi_syst_new = 1 / math.sqrt(zeta_syst)

# 12. –ü–æ–º–∏–ª–∫–∞
error_pct = abs(phi_syst_new - phi_syst_init) / phi_syst_new * 100

# 13. –§–∞–∫—Ç–∏—á–Ω–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–ø–æ—Ä–æ–∂–Ω–µ–Ω–Ω—è
# –§–æ—Ä–º—É–ª–∞: t = (2 * F * (sqrt(H1) - sqrt(H2))) / (phi * f_tr * sqrt(2 * 9.81))
g = 9.81
t_spor = (2 * F_res * (math.sqrt(H1) - math.sqrt(H2))) / (phi_syst_new * f_tr * math.sqrt(2 * g))

# --- –í–ò–í–Ü–î –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í ---

col1, col2 = st.columns(2)

with col1:
    st.subheader("üìä –ü—Ä–æ–º—ñ–∂–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏")
    st.write(f"**–°—É–º–∞—Ä–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –º.–æ. $\zeta_c$:** {zeta_c:.2f}")
    st.write(f"**–î–æ–ø—É—Å—Ç–∏–º–∏–π —á–∞—Å –∑–ª–∏–≤—É $t_{{—Å–ø.–º}}$:** {t_sp_m} —Å")
    st.write(f"**–®–≤–∏–¥–∫—ñ—Å—Ç—å –ø–æ—Ç–æ–∫—É $w$:** {w:.3f} –º/—Å")
    st.write(f"**–ß–∏—Å–ª–æ –†–µ–π–Ω–æ–ª—å–¥—Å–∞ $Re$:** {Re:.2f}")
    st.write(f"**–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Ç–µ—Ä—Ç—è $\lambda$:** {lambda_f:.4f}")

with col2:
    st.subheader("‚úÖ –û—Å—Ç–∞—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏")
    st.metric("–£—Ç–æ—á–Ω–µ–Ω–∏–π $\phi_{—Å–∏—Å—Ç}$", f"{phi_syst_new:.3f}")
    st.metric("–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É", f"{error_pct:.2f} %")
    
    color = "normal" if t_spor <= t_sp_m else "inverse"
    st.metric("–§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å –∑–ª–∏–≤—É $t_{—Å–ø–æ—Ä}$", f"{t_spor:.1f} —Å", 
              delta=f"{t_sp_m - t_spor:.1f} —Å –∑–∞–ø–∞—Å—É", delta_color=color)

st.divider()

# –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —É —Ñ–æ—Ä–º–∞—Ç—ñ –∑–≤—ñ—Ç—É
with st.expander("–ü–æ–¥–∏–≤–∏—Ç–∏—Å—è –¥–µ—Ç–∞–ª—å–Ω–∏–π —Ö—ñ–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É"):
    st.markdown(f"""
    1.  **–°—É–º–∞—Ä–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –º—ñ—Å—Ü–µ–≤–∏—Ö –æ–ø–æ—Ä—ñ–≤:**
        $$\zeta_c = \sum N_i \\times \\xi_i = {zeta_c:.2f}$$
    2.  **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:**
        $$t_{{—Å–ø.–º}} = [t]_{{–∑–ª}} - t_{{–æ–ø–µ—Ä}} = {t_zl_max} - {t_oper} = {t_sp_m} \ c$$
    3.  **–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∏—Ç—Ä–∞—Ç–∏:**
        $$\phi_{{—Å–∏—Å—Ç}} = 1 / \sqrt{{\zeta_c}} = {phi_syst_init:.3f}$$
    4.  **–ß–∏—Å–ª–æ –†–µ–π–Ω–æ–ª—å–¥—Å–∞:**
        $$Re = \\frac{{w \\cdot d_{{–≤–Ω}} \\cdot \\rho}}{{\mu}} = {Re:.2f}$$
    5.  **–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –æ–ø–æ—Ä—É —Å–∏—Å—Ç–µ–º–∏ (–∑ —Ç–µ—Ä—Ç—è–º):**
        $$\zeta_{{—Å–∏—Å—Ç}} = \zeta_c + (\\lambda / d_{{–≤–Ω}}) \\cdot \sum L_i = {zeta_syst:.3f}$$
    6.  **–£—Ç–æ—á–Ω–µ–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∏—Ç—Ä–∞—Ç–∏:**
        $$\phi'_{{—Å–∏—Å—Ç}} = {phi_syst_new:.3f}$$
    7.  **–§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å —Å–ø–æ—Ä–æ–∂–Ω–µ–Ω–Ω—è:**
        $$t_{{—Å–ø–æ—Ä}} = \\frac{{2F(\sqrt{{H_1}} - \sqrt{{H_2}})}}{{\phi'_{{—Å–∏—Å—Ç}} \cdot f_{{—Ç—Ä}} \cdot \sqrt{{2g}}}} = {t_spor:.1f} \ c$$
    """)

if t_spor <= t_sp_m:
    st.success("‚úîÔ∏è –£–º–æ–≤–∞ –±–µ–∑–ø–µ–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–∞: –°–∏—Å—Ç–µ–º–∞ –≤—Å—Ç–∏–≥–∞—î —Å–ø–æ—Ä–æ–∂–Ω–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä —É –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π —á–∞—Å.")
else:
    st.error("‚ùå –£–º–æ–≤–∞ –±–µ–∑–ø–µ–∫–∏ –ù–ï –≤–∏–∫–æ–Ω–∞–Ω–∞: –ß–∞—Å —Å–ø–æ—Ä–æ–∂–Ω–µ–Ω–Ω—è –ø–µ—Ä–µ–≤–∏—â—É—î –¥–æ–ø—É—Å—Ç–∏–º–∏–π!")
